import LongPressRouteCard from '@/components/LongPressRouteCard';
import { useNotification } from '@/contexts/NotificationContext';
import { useXp } from '@/contexts/XpContext';
import { calculateCompletionXpForRoute } from '@/utils/routes';
import React, { useState } from 'react';
import {
  Modal,
  ScrollView,
  Text,
  TouchableOpacity,
  View
} from 'react-native';
import Animated, {
  useAnimatedStyle,
  useSharedValue,
  withSequence,
  withSpring,
  withTiming,
} from 'react-native-reanimated';

// Mock route grades for testing
const MOCK_GRADES = [
  { label: 'V0 (Easy)', value: 'V0', xp: 30 },
  { label: 'V3 (Medium)', value: 'V3', xp: 60 },
  { label: 'V6 (Hard)', value: 'V6', xp: 120 },
  { label: 'V10 (Very Hard)', value: 'V10', xp: 240 },
  { label: '5.10a (Rope)', value: '5.10a', xp: 50 },
  { label: '5.12a (Hard Rope)', value: '5.12a', xp: 150 },
];

export default function TestingScreen() {
  const { gainXp, currentXp, currentLevel, xpToNextLevel, getXpForLevel } = useXp();
  const { showNotification } = useNotification();

  // Mock route popup state
  const [showMockPopup, setShowMockPopup] = useState(false);
  const [selectedGrade, setSelectedGrade] = useState(MOCK_GRADES[0]);
  const [mockCompletions, setMockCompletions] = useState(0);
  const [isFlash, setIsFlash] = useState(false);
  const [mockAttempts, setMockAttempts] = useState(0);

  // Animation values for button feedback
  const buttonScale = useSharedValue(1);

  const animateButtonPress = () => {
    buttonScale.value = withSequence(
      withTiming(0.95, { duration: 50 }),
      withSpring(1, { damping: 10 })
    );
  };

  const buttonAnimatedStyle = useAnimatedStyle(() => ({
    transform: [{ scale: buttonScale.value }],
  }));

  // XP trigger handlers
  const handleSmallXpGain = () => {
    animateButtonPress();
    gainXp({
      totalXp: 50,
      baseXp: 40,
      xpExtrapolated: [
        { type: 'First Send Bonus', xp: 10 },
      ],
    });
  };

  const handleMediumXpGain = () => {
    animateButtonPress();
    gainXp({
      totalXp: 200,
      baseXp: 120,
      xpExtrapolated: [
        { type: 'First Send Bonus', xp: 25 },
        { type: 'Flash Bonus', xp: 55 },
      ],
    });
  };

  const handleLevelUp = () => {
    animateButtonPress();
    // Calculate XP needed to level up
    const xpNeeded = xpToNextLevel + 10;
    gainXp({
      totalXp: xpNeeded,
      baseXp: Math.floor(xpNeeded * 0.6),
      xpExtrapolated: [
        { type: 'New Highest Grade Bonus', xp: 250 },
        { type: 'First Send Bonus', xp: 25 },
        { type: 'Base XP', xp: Math.floor(xpNeeded * 0.6) - 275 },
      ],
    });
  };

  const handleMultiLevelUp = () => {
    animateButtonPress();
    // Calculate XP for 2+ levels
    const level1Xp = xpToNextLevel;
    const level2Xp = getXpForLevel(currentLevel + 2) - getXpForLevel(currentLevel + 1);
    const totalNeeded = level1Xp + level2Xp + 50;
    gainXp({
      totalXp: totalNeeded,
      baseXp: Math.floor(totalNeeded * 0.5),
      xpExtrapolated: [
        { type: 'New Highest Grade Bonus', xp: 250 },
        { type: 'First Send Bonus', xp: 25 },
        { type: 'Bonus XP', xp: 100 },
        { type: 'Base XP', xp: Math.floor(totalNeeded * 0.5) - 375 },
      ],
    });
  };

  // Notification handlers
  const handleSuccessNotification = () => {
    animateButtonPress();
    showNotification({
      message: 'Route completed successfully! Great climb!',
      color: 'green',
    });
  };

  const handleErrorNotification = () => {
    animateButtonPress();
    showNotification({
      message: 'Something went wrong. Please try again.',
      color: 'red',
    });
  };

  // Mock route completion
  const handleMockComplete = () => {
    const xpData = calculateCompletionXpForRoute({
      grade: selectedGrade.value,
      previousCompletions: mockCompletions,
      newHighestGrade: mockCompletions === 0,
      bonusXp: isFlash ? 50 : 0,
    });

    if (xpData.xp > 0) {
      gainXp({
        totalXp: xpData.xp,
        baseXp: xpData.baseXp,
        xpExtrapolated: xpData.xpExtrapolated,
      });
    }

    setMockCompletions((prev) => prev + 1);
    showNotification({
      message: `Completed ${selectedGrade.label}! +${xpData.xp} XP`,
      color: 'green',
    });
  };

  // Mock route attempt
  const handleMockAttempt = () => {
    setMockAttempts((prev) => prev + 1);
    showNotification({
      message: `Attempt logged on ${selectedGrade.label}`,
      color: 'green',
    });
  };

  const resetMockRoute = () => {
    setMockCompletions(0);
    setMockAttempts(0);
    setIsFlash(false);
  };

  // Mock route for long press testing
  const [mockRouteCompleted, setMockRouteCompleted] = useState(false);
  const mockRoute = {
    id: 'test-route-1',
    title: 'Test Boulder',
    color: 'purple',
    grade: 'v4',
    type: 'boulder',
    location: 'TestWall',
    completed: mockRouteCompleted,
    setDate: new Date().toISOString(),
    completions: mockRouteCompleted ? [{ id: 1, userId: 'test', routeId: 'test-route-1', completionDate: new Date().toISOString(), xpEarned: 44, flash: true }] : [],
    bonusXp: 25,
    isArchive: false,
  };

  const handleMockRoutePress = () => {
    showNotification({
      message: 'Route popup would open here!',
      color: 'green',
    });
  };

  const handleMockQuickComplete = () => {
    setMockRouteCompleted(true);
    showNotification({
      message: '⚡ Quick completed as flash!',
      color: 'green',
    });
  };

  const resetMockLongPressRoute = () => {
    setMockRouteCompleted(false);
  };

  return (
    <ScrollView className="flex-1 bg-black p-4">
      <View className="mb-6">
        <Text className="text-white text-2xl font-plus-jakarta-700 mb-2">
          Animation Testing
        </Text>
        <Text className="text-gray-400 text-sm font-plus-jakarta">
          Test XP notifications and animations without affecting the database.
        </Text>
      </View>

      {/* Current XP Status */}
      <View className="bg-slate-800 rounded-xl p-4 mb-6">
        <Text className="text-gray-400 text-xs font-plus-jakarta mb-2">CURRENT STATUS</Text>
        <View className="flex-row justify-between">
          <View>
            <Text className="text-white text-lg font-plus-jakarta-500">Level {currentLevel}</Text>
            <Text className="text-gray-400 text-sm font-plus-jakarta">{currentXp} Total XP</Text>
          </View>
          <View className="items-end">
            <Text className="text-blue-400 text-lg font-plus-jakarta-500">{xpToNextLevel} XP</Text>
            <Text className="text-gray-400 text-sm font-plus-jakarta">to next level</Text>
          </View>
        </View>
      </View>

      {/* XP Trigger Buttons */}
      <View className="mb-6">
        <Text className="text-white text-lg font-plus-jakarta-600 mb-3">XP Triggers</Text>
        <View className="gap-3">
          <Animated.View style={buttonAnimatedStyle}>
            <TouchableOpacity
              onPress={handleSmallXpGain}
              className="bg-green-600 rounded-lg py-3 px-4 items-center"
            >
              <Text className="text-white text-base font-plus-jakarta-500">+50 XP (Small Gain)</Text>
            </TouchableOpacity>
          </Animated.View>

          <TouchableOpacity
            onPress={handleMediumXpGain}
            className="bg-blue-600 rounded-lg py-3 px-4 items-center"
          >
            <Text className="text-white text-base font-plus-jakarta-500">+200 XP (Medium Gain)</Text>
          </TouchableOpacity>

          <TouchableOpacity
            onPress={handleLevelUp}
            className="bg-yellow-600 rounded-lg py-3 px-4 items-center"
          >
            <Text className="text-white text-base font-plus-jakarta-500">Level Up!</Text>
          </TouchableOpacity>

          <TouchableOpacity
            onPress={handleMultiLevelUp}
            className="bg-red-600 rounded-lg py-3 px-4 items-center"
          >
            <Text className="text-white text-base font-plus-jakarta-500">Multi Level Up (+2)</Text>
          </TouchableOpacity>
        </View>
      </View>

      {/* Notification Triggers */}
      <View className="mb-6">
        <Text className="text-white text-lg font-plus-jakarta-600 mb-3">Notifications</Text>
        <View className="flex-row gap-3">
          <TouchableOpacity
            onPress={handleSuccessNotification}
            className="flex-1 bg-green-600/30 border border-green-500 rounded-lg py-3 px-4 items-center"
          >
            <Text className="text-green-400 text-base font-plus-jakarta-500">Success</Text>
          </TouchableOpacity>

          <TouchableOpacity
            onPress={handleErrorNotification}
            className="flex-1 bg-red-600/30 border border-red-500 rounded-lg py-3 px-4 items-center"
          >
            <Text className="text-red-400 text-base font-plus-jakarta-500">Error</Text>
          </TouchableOpacity>
        </View>
      </View>

      {/* Long Press Route Card Test */}
      <View className="mb-6">
        <Text className="text-white text-lg font-plus-jakarta-600 mb-3">Long Press Route Card</Text>
        <Text className="text-gray-400 text-xs font-plus-jakarta mb-3">
          Tap to "open popup" • Hold to quick complete as flash
        </Text>
        <View className="mb-3">
          <LongPressRouteCard
            route={mockRoute}
            onPress={handleMockRoutePress}
            onQuickComplete={handleMockQuickComplete}
            xpDisplay={
              !mockRouteCompleted ? (
                <View className="bg-black border border-green-400 rounded-full px-2 py-1">
                  <Text className="text-green-400 text-base font-plus-jakarta-700 italic">
                    69xp
                  </Text>
                </View>
              ) : null
            }
          />
        </View>
        <TouchableOpacity
          onPress={resetMockLongPressRoute}
          className="bg-gray-700 rounded-lg py-2 px-4 items-center"
        >
          <Text className="text-gray-300 text-sm font-plus-jakarta-500">Reset Route</Text>
        </TouchableOpacity>
      </View>

      {/* Mock Route Popup */}
      <View className="mb-6">
        <Text className="text-white text-lg font-plus-jakarta-600 mb-3">Mock Route Popup</Text>
        <TouchableOpacity
          onPress={() => setShowMockPopup(true)}
          className="bg-purple-600 rounded-lg py-3 px-4 items-center"
        >
          <Text className="text-white text-base font-plus-jakarta-500">Open Mock Route</Text>
        </TouchableOpacity>
      </View>

      {/* Mock Route Popup Modal */}
      <Modal
        visible={showMockPopup}
        animationType="slide"
        transparent={true}
        onRequestClose={() => setShowMockPopup(false)}
      >
        <View className="flex-1 justify-end bg-black/50">
          <View className="bg-slate-900 rounded-t-3xl p-6">
            <View className="flex-row justify-between items-center mb-4">
              <Text className="text-white text-xl font-plus-jakarta-700">Mock Route</Text>
              <TouchableOpacity onPress={() => setShowMockPopup(false)}>
                <Text className="text-gray-400 text-base font-plus-jakarta">Close</Text>
              </TouchableOpacity>
            </View>

            {/* Grade Selector */}
            <Text className="text-gray-400 text-sm font-plus-jakarta mb-2">Select Grade:</Text>
            <ScrollView horizontal showsHorizontalScrollIndicator={false} className="mb-4">
              <View className="flex-row gap-2">
                {MOCK_GRADES.map((grade) => (
                  <TouchableOpacity
                    key={grade.value}
                    onPress={() => {
                      setSelectedGrade(grade);
                      resetMockRoute();
                    }}
                    className={`px-4 py-2 rounded-lg ${selectedGrade.value === grade.value
                      ? 'bg-blue-600'
                      : 'bg-gray-700'
                      }`}
                  >
                    <Text className="text-white text-sm font-plus-jakarta-500">{grade.label}</Text>
                  </TouchableOpacity>
                ))}
              </View>
            </ScrollView>

            {/* Route Stats */}
            <View className="bg-slate-800 rounded-lg p-4 mb-4">
              <View className="flex-row justify-between mb-2">
                <Text className="text-gray-400 font-plus-jakarta">Completions:</Text>
                <Text className="text-white font-plus-jakarta-500">{mockCompletions}</Text>
              </View>
              <View className="flex-row justify-between mb-2">
                <Text className="text-gray-400 font-plus-jakarta">Attempts:</Text>
                <Text className="text-white font-plus-jakarta-500">{mockAttempts}</Text>
              </View>
              <View className="flex-row justify-between">
                <Text className="text-gray-400 font-plus-jakarta">Base XP:</Text>
                <Text className="text-green-400 font-plus-jakarta-500">{selectedGrade.xp} XP</Text>
              </View>
            </View>

            {/* Flash Toggle */}
            <TouchableOpacity
              onPress={() => setIsFlash(!isFlash)}
              className={`flex-row items-center justify-between p-4 rounded-lg mb-4 ${isFlash ? 'bg-yellow-600/30 border border-yellow-500' : 'bg-gray-700'
                }`}
            >
              <Text className="text-white font-plus-jakarta-500">Flash (First Try)</Text>
              <View
                className={`w-6 h-6 rounded-full ${isFlash ? 'bg-yellow-500' : 'bg-gray-500'}`}
              />
            </TouchableOpacity>

            {/* Action Buttons */}
            <View className="gap-3">
              <TouchableOpacity
                onPress={handleMockComplete}
                className="bg-green-600 rounded-lg py-4 items-center"
              >
                <Text className="text-white text-lg font-plus-jakarta-700">Complete Route</Text>
              </TouchableOpacity>

              <TouchableOpacity
                onPress={handleMockAttempt}
                className="bg-blue-600 rounded-lg py-4 items-center"
              >
                <Text className="text-white text-lg font-plus-jakarta-700">Log Attempt</Text>
              </TouchableOpacity>

              <TouchableOpacity
                onPress={resetMockRoute}
                className="bg-gray-700 rounded-lg py-3 items-center"
              >
                <Text className="text-gray-300 text-base font-plus-jakarta-500">Reset Stats</Text>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </Modal>

      {/* Info Note */}
      <View className="bg-slate-800/50 rounded-lg p-4 mb-8">
        <Text className="text-gray-400 text-xs font-plus-jakarta text-center">
          This tab is for testing only. No data is sent to the server.
          {'\n'}All XP gains here are local and reset when you restart the app.
        </Text>
      </View>
    </ScrollView>
  );
}

